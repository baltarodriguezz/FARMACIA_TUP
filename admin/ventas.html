<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Administrar Ventas - Farmacia Luz</title>
  <link rel="stylesheet" href="../assets/output.css" />
  <script src="../assets/js/api.js"></script>
</head>
<body class="bg-gray-100 flex min-h-screen font-sans">

  <!-- SIDEBAR -->
  <aside class="w-64 bg-[#275c74] text-white flex flex-col justify-between">
    <div>
      <div class="p-6 border-b border-white/20">
        <h2 class="text-2xl font-bold text-center">Admin Farmacia</h2>
      </div>
      <nav class="flex flex-col gap-2 p-4">
        <a href="index.html" class="py-2 px-3 rounded hover:bg-[#12b1be] transition"> Dashboard</a>
        <a href="productos.html" class="py-2 px-3 rounded hover:bg-[#12b1be] transition">Т Productos</a>
        <a href="clientes.html" class="py-2 px-3 rounded hover:bg-[#12b1be] transition"> Clientes</a>
        <a href="ventas.html" class="py-2 px-3 bg-[#12b1be] rounded font-semibold">Ь Ventas</a>
      </nav>
    </div>
    <div class="p-4 text-center border-t border-white/20 text-sm opacity-80">
      漏 2025 Farmacia Luz
    </div>
  </aside>

  <!-- CONTENIDO -->
  <main class="flex-1 p-8 space-y-6">

    <!-- T铆tulo + resumen -->
    <div class="flex justify-between items-center">
      <div>
        <h1 class="text-3xl font-bold text-[#275c74]">Gesti贸n de Ventas</h1>
        <p class="text-sm text-gray-600">Listado de facturas y filtros por cliente, fechas y recaudaci贸n.</p>
      </div>

      <!-- Tarjeta recaudaci贸n total -->
      <div class="bg-white rounded-xl shadow px-6 py-4 text-right">
        <p class="text-sm text-gray-500">Recaudaci贸n total</p>
        <p id="lblRecaudacion" class="text-2xl font-bold text-[#12b1be]">$0</p>
      </div>
    </div>

    <!-- Filtros -->
    <section class="bg-white rounded-xl shadow p-4 flex flex-wrap gap-4 items-end">

      <!-- Filtro por cliente -->
      <div class="flex flex-col">
        <label for="selectCliente" class="text-sm font-medium text-gray-700 mb-1">Filtrar por cliente</label>
        <select id="selectCliente" class="border rounded-lg px-3 py-2 min-w-[220px]">
          <option value="">Todos los clientes</option>
        </select>
      </div>

      <!-- Filtro por fechas -->
      <div class="flex flex-col">
        <label class="text-sm font-medium text-gray-700 mb-1">Desde</label>
        <input id="fechaInicio" type="date" class="border rounded-lg px-3 py-2" />
      </div>
      <div class="flex flex-col">
        <label class="text-sm font-medium text-gray-700 mb-1">Hasta</label>
        <input id="fechaFin" type="date" class="border rounded-lg px-3 py-2" />
      </div>

      <!-- Botones de acci贸n -->
      <div class="flex flex-wrap gap-2 ml-auto">
        <button id="btnTodas"
                class="bg-gray-200 hover:bg-gray-300 text-gray-800 px-4 py-2 rounded-lg text-sm font-medium">
           Todas las ventas
        </button>
        <button id="btnPorCliente"
                class="bg-[#12b1be] hover:bg-[#0e9ca9] text-white px-4 py-2 rounded-lg text-sm font-medium">
           Filtrar por cliente
        </button>
        <button id="btnEntreFechas"
                class="bg-[#275c74] hover:bg-[#1f4d60] text-white px-4 py-2 rounded-lg text-sm font-medium">
           Ventas entre fechas
        </button>
        <button id="btnRecaudacion"
                class="bg-emerald-500 hover:bg-emerald-600 text-white px-4 py-2 rounded-lg text-sm font-medium">
           Actualizar recaudaci贸n
        </button>
      </div>

    </section>

    <!-- Tabla de ventas -->
    <section class="overflow-x-auto bg-white rounded-xl shadow">
      <table class="w-full table-fixed border-collapse text-sm">
        <thead class="bg-[#275c74] text-white">
          <tr>
            <th class="p-3 text-left">Factura</th>
            <th class="p-3 text-left">Fecha</th>
            <th class="p-3 text-left">Cliente</th>
            <th class="p-3 text-left">Forma de pago</th>
            <th class="p-3 text-right">Total</th>
            <th class="p-3 text-center">Acciones</th>
          </tr>
        </thead>
        <tbody id="tablaVentas" class="divide-y">
          </tbody>
      </table>
    </section>

  </main>

  <!-- MODAL DETALLE FACTURA -->
  <div id="modalDetalle" class="hidden fixed inset-0 bg-black/40 flex items-center justify-center z-50">
    <div class="bg-white rounded-xl shadow-xl w-full max-w-2xl p-6">
      <div class="flex justify-between items-center mb-4">
        <h2 class="text-xl font-bold text-[#275c74]">Detalle de factura</h2>
        <button id="btnCerrarDetalle" class="text-gray-500 hover:text-gray-800 text-lg">&times;</button>
      </div>

      <!-- Info cabecera -->
      <div class="grid grid-cols-2 gap-2 text-sm mb-4">
        <p><span class="font-semibold">Factura:</span> <span id="detNro"></span></p>
        <p><span class="font-semibold">Fecha:</span> <span id="detFecha"></span></p>
        <p><span class="font-semibold">Cliente:</span> <span id="detCliente"></span></p>
        <p><span class="font-semibold">Forma de pago:</span> <span id="detFormaPago"></span></p>
        <p class="col-span-2 text-right">
          <span class="font-semibold">Total:</span>
          <span id="detTotal" class="text-[#12b1be] font-bold"></span>
        </p>
      </div>

      <!-- Detalle items -->
      <div class="overflow-x-auto border rounded-lg">
        <table class="min-w-full text-sm">
          <thead class="bg-gray-100">
            <tr>
              <th class="p-2 text-left">Producto</th>
              <th class="p-2 text-right">Cantidad</th>
              <th class="p-2 text-right">Precio unitario</th>
              <th class="p-2 text-right">Subtotal</th>
            </tr>
          </thead>
          <tbody id="tablaDetalle" class="divide-y">
            <!-- JS rellena -->
          </tbody>
        </table>
      </div>
    </div>
  </div>

  <!-- SCRIPT VENTAS -->
   <!-- SCRIPT VENTAS -->
    <script>
      const tabla = document.getElementById("tablaVentas");
      const lblRecaudacion = document.getElementById("lblRecaudacion");
      const lblRecaudacionTitulo = lblRecaudacion.parentElement.querySelector("p");
      const selectCliente = document.getElementById("selectCliente");
      const inputFechaInicio = document.getElementById("fechaInicio");
      const inputFechaFin = document.getElementById("fechaFin");

      const modalDetalle = document.getElementById("modalDetalle");
      const btnCerrarDetalle = document.getElementById("btnCerrarDetalle");
      const detNro = document.getElementById("detNro");
      const detFecha = document.getElementById("detFecha");
      const detCliente = document.getElementById("detCliente");
      const detFormaPago = document.getElementById("detFormaPago");
      const detTotal = document.getElementById("detTotal");
      const tablaDetalle = document.getElementById("tablaDetalle");

      let facturas = [];
      let clientesMap = {};
      let suministrosMap = {};
      let ultimaListaMostrada = [];

      let selectOrdenCampo;
      let selectOrdenDireccion;
      let menuRecaudaciones;

      let formasPagoMap = {};

      function inicializarControlesOrden() {
        const seccionFiltros = document.querySelector("main section.bg-white.rounded-xl.shadow");
        if (!seccionFiltros) return;

        const contenedorOrdenCampo = document.createElement("div");
        contenedorOrdenCampo.className = "flex flex-col";
        contenedorOrdenCampo.innerHTML = `
          <label class="text-sm font-medium text-gray-700 mb-1">Ordenar por</label>
          <select class="border rounded-lg px-3 py-2 min-w-[180px]">
            <option value="">Sin orden</option>
            <option value="total">Total de venta</option>
            <option value="formaPago">Forma de pago</option>
          </select>
        `;

        const contenedorOrdenDireccion = document.createElement("div");
        contenedorOrdenDireccion.className = "flex flex-col";
        contenedorOrdenDireccion.innerHTML = `
          <label class="text-sm font-medium text-gray-700 mb-1">Direcci贸n</label>
          <select class="border rounded-lg px-3 py-2 min-w-[150px]">
            <option value="asc">Ascendente (menor a mayor / A-Z)</option>
            <option value="desc">Descendente (mayor a menor / Z-A)</option>
          </select>
        `;

        const botonesAccion = seccionFiltros.querySelector("div.ml-auto");

        if (botonesAccion) {
          seccionFiltros.insertBefore(contenedorOrdenCampo, botonesAccion);
          seccionFiltros.insertBefore(contenedorOrdenDireccion, botonesAccion);
        } else {
          seccionFiltros.appendChild(contenedorOrdenCampo);
          seccionFiltros.appendChild(contenedorOrdenDireccion);
        }

        selectOrdenCampo = contenedorOrdenCampo.querySelector("select");
        selectOrdenDireccion = contenedorOrdenDireccion.querySelector("select");

        selectOrdenCampo.addEventListener("change", () => {
          renderTabla(ultimaListaMostrada);
        });

        selectOrdenDireccion.addEventListener("change", () => {
          renderTabla(ultimaListaMostrada);
        });
      }

      function crearMenuRecaudaciones() {
        if (menuRecaudaciones) return menuRecaudaciones;

        const seccionFiltros = document.querySelector("main section.bg-white.rounded-xl.shadow");
        if (!seccionFiltros) return null;

        const contenedor = document.createElement("div");
        contenedor.className = "w-full mt-3 flex flex-wrap gap-2";
        contenedor.innerHTML = `
          <button id="btnRecDiaria"
                  class="bg-emerald-500 hover:bg-emerald-600 text-white px-3 py-2 rounded-lg text-sm font-medium">
            Recaudaci贸n diaria
          </button>
          <button id="btnRecMensual"
                  class="bg-emerald-500 hover:bg-emerald-600 text-white px-3 py-2 rounded-lg text-sm font-medium">
            Recaudaci贸n mensual
          </button>
          <button id="btnRecAnual"
                  class="bg-emerald-500 hover:bg-emerald-600 text-white px-3 py-2 rounded-lg text-sm font-medium">
            Recaudaci贸n anual
          </button>
        `;
        contenedor.style.display = "none";

        seccionFiltros.appendChild(contenedor);
        menuRecaudaciones = contenedor;

        const btnRecDiaria = document.getElementById("btnRecDiaria");
        const btnRecMensual = document.getElementById("btnRecMensual");
        const btnRecAnual = document.getElementById("btnRecAnual");

        if (btnRecDiaria) {
          btnRecDiaria.addEventListener("click", () => {
            actualizarRecaudacionPeriodo("diaria");
          });
        }
        if (btnRecMensual) {
          btnRecMensual.addEventListener("click", () => {
            actualizarRecaudacionPeriodo("mensual");
          });
        }
        if (btnRecAnual) {
          btnRecAnual.addEventListener("click", () => {
            actualizarRecaudacionPeriodo("anual");
          });
        }

        return menuRecaudaciones;
      }

      async function cargarDatosIniciales() {
    try {
     // --- MODIFICACIN: A帽adir formas-pago al Promise.all ---
     const [facturasData, clientesData, suministrosData, formasPagoData] = await Promise.all([
      apiGet("Factura"),
      apiGet("Clientes"),
      apiGet("Suministros"),
      apiGet("Factura/formas-pago") // <-- AADIDO
     ]);

     facturas = facturasData || [];

     // Cargar Clientes
     clientesMap = {};
     clientesData.forEach(c => {
      clientesMap[c.idCliente] = c;
     });

     selectCliente.innerHTML = '<option value="">Todos los clientes</option>';

     clientesData.forEach(c => {
      const opt = document.createElement("option");
      opt.value = c.idCliente;
      // --- MODIFICACIN: Mostrar Nombre y Apellido ---
      opt.textContent = `${c.nombre} ${c.apellido}`; // <-- MODIFICADO
      selectCliente.appendChild(opt);
     });

     // Cargar Suministros
     suministrosMap = {};
     suministrosData.forEach(s => {
      suministrosMap[s.idSuministro] = s;
     });

     // --- AADIDO: Cargar Formas de Pago ---
     formasPagoMap = {};
     formasPagoData.forEach(fp => {
      formasPagoMap[fp.idFormaPago] = fp.descripcion;
     });
     // --- FIN AADIDO ---

     renderTabla(facturas);
     actualizarRecaudacionPeriodo("diaria");
    } catch (err) {
     console.error("Error cargando datos iniciales", err);
     alert("Error al cargar datos de ventas.");
    }
   }

      function aplicarOrden(lista) {
        if (!Array.isArray(lista) || lista.length === 0) {
          return [];
        }

        if (!selectOrdenCampo || !selectOrdenDireccion) {
          return [...lista];
        }

        const campo = selectOrdenCampo.value;
        const direccion = selectOrdenDireccion.value || "asc";

        if (!campo) {
          return [...lista];
        }

        const copia = [...lista];

        copia.sort((a, b) => {
          let va;
          let vb;

          if (campo === "total") {
            va = Number(a.total || 0);
            vb = Number(b.total || 0);
          } else if (campo === "formaPago") {
            const fa = formasPago[a.idFormaPago] || "";
            const fb = formasPago[b.idFormaPago] || "";
            va = fa.toString().toLowerCase();
            vb = fb.toString().toLowerCase();
          } else {
            return 0;
          }

          if (va < vb) return direccion === "asc" ? -1 : 1;
          if (va > vb) return direccion === "asc" ? 1 : -1;
          return 0;
        });

        return copia;
      }
function renderTabla(lista) {
    tabla.innerHTML = "";

    ultimaListaMostrada = Array.isArray(lista) ? lista : [];

    if (!ultimaListaMostrada || ultimaListaMostrada.length === 0) {
        tabla.innerHTML = `
            <tr>
                <td colspan="6" class="p-4 text-center text-gray-500">
                    No hay facturas para mostrar.
                </td>
            </tr>`;
        return;
    }

    const listaOrdenada = aplicarOrden(ultimaListaMostrada);

    listaOrdenada.forEach(f => {
        const tr = document.createElement("tr");

        const clienteObj = clientesMap[f.idCliente];
        const cliente = clienteObj
            ? `${clienteObj.nombre} ${clienteObj.apellido}`
            : `ID ${f.idCliente}`;

        const forma = formasPagoMap[f.idFormaPago] || `ID ${f.idFormaPago}`;

        const fecha = f.fechaEmision
            ? new Date(f.fechaEmision).toLocaleDateString("es-AR")
            : "";

        const total = f.total != null ? f.total.toFixed(2) : "0.00";

        tr.innerHTML = `
            <td class="p-3">#${f.idFactura}</td>
            <td class="p-3">${fecha}</td>
            <td class="p-3">${cliente}</td>
            <td class="p-3">${forma}</td>
            <td class="p-3 text-right">$${total}</td>
            <td class="p-3 text-center">
                <span class="text-blue-600 hover:underline cursor-pointer" onclick="verDetalle(${f.idFactura})">
                    Ver detalle
                </span>
            </td>
        `;
        tabla.appendChild(tr);
    });
}

      function actualizarRecaudacionPeriodo(tipo) {
        if (!Array.isArray(facturas) || facturas.length === 0) {
          lblRecaudacion.textContent = "$0.00";
          return;
        }

        const ahora = new Date();
        let desde;
        let hasta;

        if (tipo === "diaria") {
          desde = new Date(ahora.getFullYear(), ahora.getMonth(), ahora.getDate(), 0, 0, 0, 0);
          hasta = new Date(ahora.getFullYear(), ahora.getMonth(), ahora.getDate(), 23, 59, 59, 999);
        } else if (tipo === "mensual") {
          desde = new Date(ahora.getFullYear(), ahora.getMonth(), 1, 0, 0, 0, 0);
          hasta = new Date(ahora.getFullYear(), ahora.getMonth() + 1, 0, 23, 59, 59, 999);
        } else if (tipo === "anual") {
          desde = new Date(ahora.getFullYear(), 0, 1, 0, 0, 0, 0);
          hasta = new Date(ahora.getFullYear(), 11, 31, 23, 59, 59, 999);
        } else {
          desde = new Date(ahora.getFullYear(), ahora.getMonth(), ahora.getDate(), 0, 0, 0, 0);
          hasta = new Date(ahora.getFullYear(), ahora.getMonth(), ahora.getDate(), 23, 59, 59, 999);
        }

        let suma = 0;

        facturas.forEach(f => {
          if (!f.fechaEmision) return;
          const fecha = new Date(f.fechaEmision);
          if (isNaN(fecha.getTime())) return;

          if (fecha >= desde && fecha <= hasta) {
            suma += Number(f.total || 0);
          }
        });

        lblRecaudacion.textContent = "$" + suma.toFixed(2);

        if (lblRecaudacionTitulo) {
          if (tipo === "diaria") {
            lblRecaudacionTitulo.textContent = "Recaudaci贸n diaria";
          } else if (tipo === "mensual") {
            lblRecaudacionTitulo.textContent = "Recaudaci贸n mensual";
          } else if (tipo === "anual") {
            lblRecaudacionTitulo.textContent = "Recaudaci贸n anual";
          } else {
            lblRecaudacionTitulo.textContent = "Recaudaci贸n";
          }
        }
      }

      document.getElementById("btnTodas").addEventListener("click", () => {
        renderTabla(facturas);
      });

      document.getElementById("btnRecaudacion").addEventListener("click", () => {
        const btn = document.getElementById("btnRecaudacion");
        if (btn) {
          btn.textContent = "Recaudaciones";
        }

        const menu = crearMenuRecaudaciones();
        if (!menu) return;

        if (menu.style.display === "none") {
          menu.style.display = "flex";
        } else {
          menu.style.display = "none";
        }
      });

      document.getElementById("btnPorCliente").addEventListener("click", async () => {
        const idCliente = selectCliente.value;

        if (!idCliente) {
          alert("Seleccion谩 un cliente para filtrar.");
          return;
        }

        try {
          const lista = await apiGet(`Factura/FacturaPorCliente/${idCliente}`);
          renderTabla(lista);
        } catch (err) {
          console.error(err);
          alert("Error al filtrar por cliente.");
        }
      });

      document.getElementById("btnEntreFechas").addEventListener("click", async () => {
        const desde = inputFechaInicio.value;
        const hasta = inputFechaFin.value;

        if (!desde || !hasta) {
          alert("Seleccion谩 fecha de inicio y fin.");
          return;
        }

        try {
          const url = `Factura/entre-fecha?fechaInicio=${desde}&fechaFin=${hasta}`;
          const lista = await apiGet(url);
          renderTabla(lista);
        } catch (err) {
          console.error(err);
          alert("Error al filtrar por fechas.");
        }
      });

      // Reemplaza esta funci贸n completa en ventas.html

window.verDetalle = async function (idFactura) {
    try {
        let f = facturas.find(x => x.idFactura === idFactura);

        if (!f) {
            f = await apiGet(`Factura/${idFactura}`);
        }

        // --- MODIFICACIN CLIENTE ---
        const clienteObj = clientesMap[f.idCliente];
        const cliente = clienteObj
            ? `${clienteObj.nombre} ${clienteObj.apellido}`
            : `ID ${f.idCliente}`;
        // --- FIN MODIFICACIN ---

        // --- MODIFICACIN FORMA PAGO ---
        const forma = formasPagoMap[f.idFormaPago] || `ID ${f.idFormaPago}`;
        // --- FIN MODIFICACIN ---

        const fecha = f.fechaEmision
            ? new Date(f.fechaEmision).toLocaleDateString("es-AR")
            : "";
        const total = f.total != null ? f.total.toFixed(2) : "0.00";

        detNro.textContent = "#" + f.idFactura;
        detFecha.textContent = fecha;
        detCliente.textContent = cliente; // <-- Arreglado
        detFormaPago.textContent = forma; // <-- Arreglado
        detTotal.textContent = "$" + total;

        tablaDetalle.innerHTML = "";
        if (f.detalles && f.detalles.length > 0) {
            f.detalles.forEach(d => {
                const s = suministrosMap[d.idSuministro];
                const nombreProd = s ? s.descripcion : `ID ${d.idSuministro}`;
                const precio = Number(d.precioUnitario || 0);
                const cant = d.cantidad || 0;
                const sub = precio * cant;

                const tr = document.createElement("tr");
                tr.innerHTML = `
                    <td class="p-2">${nombreProd}</td>
                    <td class="p-2 text-right">${cant}</td>
                    <td class="p-2 text-right">$${precio.toFixed(2)}</td>
                    <td class="p-2 text-right">$${sub.toFixed(2)}</td>
                `;
                tablaDetalle.appendChild(tr);
            }); // <-- Aqu铆 estaba mi error, ahora est谩 limpio.
        } else {
            tablaDetalle.innerHTML = `
                <tr>
                    <td colspan="4" class="p-3 text-center text-gray-500">
                        Esta factura no tiene 铆tems de detalle.
                    </td>
                </tr>`;
        }

        modalDetalle.classList.remove("hidden");
    } catch (err) {
        console.error(err);
        alert("No se pudo cargar el detalle de la factura.");
    }
};

      btnCerrarDetalle.addEventListener("click", () => {
        modalDetalle.classList.add("hidden");
      });

      inicializarControlesOrden();
      cargarDatosIniciales();
    </script>


</body>
</html>
