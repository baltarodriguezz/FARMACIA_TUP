<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Administrar Productos - Farmacia Luz</title>
  <link rel="stylesheet" href="../assets/output.css" />
  <script src="../assets/js/api.js"></script>
</head>

<body class="bg-gray-100 flex min-h-screen font-sans">

  <!-- SIDEBAR -->
  <aside class="w-64 bg-[#275c74] text-white flex flex-col justify-between">
    <div>
      <div class="p-6 border-b border-white/20">
        <h2 class="text-2xl font-bold text-center">Admin Farmacia</h2>
      </div>
      <nav class="flex flex-col gap-2 p-4">
        <a href="index.html" class="py-2 px-3 rounded hover:bg-[#12b1be] transition">üè† Dashboard</a>
        <a href="productos.html" class="py-2 px-3 bg-[#12b1be] rounded font-semibold">üß¥ Productos</a>
        <a href="clientes.html" class="py-2 px-3 rounded hover:bg-[#12b1be] transition">üë• Clientes</a>
        <a href="ventas.html" class="py-2 px-3 rounded hover:bg-[#12b1be] transition">üßæ Ventas</a>
      </nav>
    </div>
    <div class="p-4 text-center border-t border-white/20 text-sm opacity-80">
      ¬© 2025 Farmacia Luz
    </div>
  </aside>

  <!-- CONTENIDO -->
  <main class="flex-1 p-8">

    <div class="flex justify-between items-center mb-8">
      <h1 class="text-3xl font-bold text-[#275c74]">Gesti√≥n de Productos</h1>

      <button id="btnNuevo"
        class="bg-[#12b1be] hover:bg-[#0e9ca9] text-white px-4 py-2 rounded-lg transition">
        ‚ûï Nuevo Producto
      </button>
    </div>

    <!-- TABLA -->
    <div class="overflow-x-auto bg-white rounded-xl shadow-md">
      <table class="min-w-full border-collapse text-sm">
        <thead class="bg-[#275c74] text-white">
          <tr>
            <th class="p-3">ID</th>
            <th class="p-3">Nombre</th>
            <th class="p-3">Precio</th>
            <th class="p-3">Stock</th>
            <th class="p-3">Tipo</th>
            <th class="p-3">Acciones</th>
          </tr>
        </thead>
        <tbody id="tablaProductos" class="divide-y"></tbody>
      </table>
    </div>

    <!-- MODAL -->
    <div id="modalProducto"
      class="hidden fixed inset-0 bg-black/40 flex items-center justify-center z-50">
      <div class="bg-white rounded-xl p-6 w-96 shadow-xl">
        <h2 id="tituloModal" class="text-xl font-bold text-[#275c74] mb-4">Nuevo Producto</h2>

        <form id="formProducto" class="flex flex-col gap-3" novalidate>

          <input id="descripcion" placeholder="Descripci√≥n" class="border rounded p-2" />
          <input id="precioUnitario" placeholder="Precio" type="number" class="border rounded p-2" />
          <input id="stock" placeholder="Stock" type="number" class="border rounded p-2" />
          <select id="tipo_suministro" class="border rounded p-2 bg-white">
            <option value="">-- Seleccionar tipo --</option>
            </select>
          <input id="codBarra" placeholder="C√≥digo de barras" type="number" class="border rounded p-2" />
          <input id="urlImagen" placeholder="Nombre imagen (opcional)" class="border rounded p-2" />

          <div class="flex justify-end gap-2 mt-3">
            <button type="button" id="btnCancelar"
              class="px-4 py-2 rounded border border-gray-400 hover:bg-gray-200">
              Cancelar
            </button>

            <button type="submit"
              class="bg-[#12b1be] hover:bg-[#0e9ca9] text-white px-4 py-2 rounded">
              Guardar
            </button>
          </div>

        </form>
      </div>
    </div>

  </main>
<script>
const modal = document.getElementById("modalProducto");
const tabla = document.getElementById("tablaProductos");
const tituloModal = document.getElementById("tituloModal");

const inputDescripcion = document.getElementById("descripcion");
const inputPrecio      = document.getElementById("precioUnitario");
const inputStock       = document.getElementById("stock");
const inputCodBarra    = document.getElementById("codBarra");
const inputUrlImagen   = document.getElementById("urlImagen");
const inputTipoSuministro = document.getElementById("tipo_suministro");

let editId = null;
let productosCache = [];
let tiposCache = [];

// ==================== CARGAR PRODUCTOS ====================
async function cargarProductos() {
    const datos = await apiGet("Suministros");
    productosCache = datos;

    tabla.innerHTML = "";

    datos.forEach(p => {
        // --- MODIFICACI√ìN ---
        // Buscar la descripci√≥n del tipo en el cach√©
        const tipo = tiposCache.find(t => t.idTipoSuministro === p.idTipoSuministro);
        const tipoDesc = tipo ? tipo.tipo : "N/A"; // Usar "N/A" si no se encuentra

        tabla.innerHTML += `
        <tr>
            <td class="p-3">${p.idSuministro}</td>
            <td class="p-3">${p.descripcion}</td>
            <td class="p-3">$${p.precioUnitario}</td>
            <td class="p-3">${p.stock}</td>
            <td class="p-3">${tipoDesc}</td>
            <td class="p-3 flex gap-2">
                <button onclick="editar(${p.idSuministro})" class="text-blue-600 hover:underline">Editar</button>
                <button onclick="eliminar(${p.idSuministro})" class="text-red-600 hover:underline">Eliminar</button>
            </td>
        </tr>`;
    });
}
async function cargarTiposSuministro() {
    try {
        tiposCache = await apiGet("Suministros/TiposSuministros");
        
        // Limpiamos por si acaso
        inputTipoSuministro.innerHTML = '<option value="">-- Seleccionar tipo --</option>'; 
        
        // Llenamos el combo
        tiposCache.forEach(tipo => {
            const opcion = new Option(tipo.tipo, tipo.idTipoSuministro);
            inputTipoSuministro.add(opcion);
        });

    } catch (err) {
        console.error("No se pudieron cargar los tipos de suministro", err);
        alert("Error cr√≠tico: No se pudieron cargar los tipos de suministro.");
    }
}

// ==================== NUEVO ====================
document.getElementById("btnNuevo").addEventListener("click", () => {
    editId = null;
    tituloModal.textContent = "Nuevo Producto";

    inputDescripcion.value = "";
    inputPrecio.value      = "";
    inputStock.value       = "";
    inputTipoSuministro.value = "";
    inputCodBarra.value    = "";
    inputUrlImagen.value   = "";

    modal.classList.remove("hidden");
});

// ==================== CANCELAR ====================
document.getElementById("btnCancelar").addEventListener("click", () => {
    modal.classList.add("hidden");
});

// ==================== GUARDAR ====================
document.getElementById("formProducto").addEventListener("submit", async e => {
    e.preventDefault(); // Siempre prevenir el env√≠o por defecto

    // --- NUEVA VALIDACI√ìN DETALLADA ---

    // 1. Obtener todos los valores
    const descripcion = inputDescripcion.value.trim();
    const precioStr = inputPrecio.value;
    const stockStr = inputStock.value;
    const tipoSuministroIdStr = inputTipoSuministro.value;
    const codBarraStr = inputCodBarra.value;
    const urlfoto = inputUrlImagen.value.trim();

    // 2. Validar campo por campo
    if (!descripcion) {
        alert("Por favor, complet√° la Descripci√≥n.");
        return;
    }

    const precio = parseFloat(precioStr);
    if (!precioStr || isNaN(precio) || precio <= 0) {
        alert("Por favor, ingres√° un Precio v√°lido (mayor a 0).");
        return;
    }

    const stock = parseInt(stockStr);
    if (!stockStr || isNaN(stock) || stock < 0) {
        alert("Por favor, ingres√° un Stock v√°lido (0 o m√°s).");
        return;
    }

    const tipoSuministroId = parseInt(tipoSuministroIdStr);
    if (!tipoSuministroIdStr || isNaN(tipoSuministroId)) {
        alert("Por favor, seleccion√° un Tipo de Suministro.");
        return;
    }

    const codBarra = parseInt(codBarraStr);
    if (!codBarraStr || isNaN(codBarra) || codBarra <= 0) {
        alert("Por favor, ingres√° un C√≥digo de Barras v√°lido (mayor a 0).");
        return;
    }

    if (!urlfoto) {
        alert("Por favor, complet√° la URL de la Imagen.");
        return;
    }

    // --- FIN DE LA VALIDACI√ìN ---

    // 3. Si todo est√° OK, crear el objeto de datos
    const data = {
        codBarra: codBarra,
        descripcion: descripcion,
        precioUnitario: precio,
        idTipoSuministro: tipoSuministroId,
        idTipoVenta: 1, // Mantenemos el '1' que ten√≠as
        stock: stock,
        urlImagen: urlfoto
    };

    // 4. Enviar a la API
    try {
        if (editId === null) {
            await apiPost("Suministros", data);
        } else {
            await apiPut(`Suministros/${editId}`, data);
        }
    } catch (err) {
        alert("Error al guardar: " + err.message);
        console.error(err);
        return;
    }

    modal.classList.add("hidden");
    await cargarProductos();
});

// ==================== EDITAR ====================
window.editar = async id => {
    editId = id;
    tituloModal.textContent = "Editar Producto";

    const p = await apiGet(`Suministros/${id}`);

    inputDescripcion.value = p.descripcion;
    inputPrecio.value      = p.precioUnitario;
    inputStock.value       = p.stock;
    inputTipoSuministro.value = p.idTipoSuministro;
    inputCodBarra.value    = p.codBarra;
    inputUrlImagen.value   = p.urlImagen;

    modal.classList.remove("hidden");
};

// ==================== ELIMINAR ====================
window.eliminar = async id => {
    if (!confirm("¬øSeguro que deseas eliminar este producto?")) return;

    try {
        // Usamos la funci√≥n helper de api.js
        await apiDelete(`Suministros/${id}`);

    } catch (err) {
        console.error(err);
        alert("Error de red al eliminar: " + err.message);
        return;
    }

    cargarProductos();
};

// ==================== INICIO ====================
async function iniciarPagina() {
    await cargarTiposSuministro();
    await cargarProductos();
}
iniciarPagina();
</script>




</body>
</html>
